<!-- templates/home.html -->
<!DOCTYPE html>
<html>
    <head>
    <meta charset="UTF-8">
    <title>Ourgatther</title>
    <style>
      /* Example embedded CSS */
      #game {
        width: 800px;
        height: 600px;
        position: relative;
      }
      .player {
        position: absolute;
        width: 40px;
        height: 40px;
        text-align: center;
        font-size: 12px;
      }
    </style>
    </head>
<body>
<div id="top-buttons">
  <button onclick="createPlayer()">Create Player</button><i><< Create a player here !</i>
</div>
<i>Use the arrow keys to move your player. ← ↑ → ↓  (keep pressing)</i>
<br>
<i>Press the Control button to control a player. (press again if needed)</i>
<div id="game"></div>

<script>
  //const socket = new WebSocket("ws://localhost:8080/ws");
  const socket = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws");


  socket.onopen = () => {
      console.log("Connected to WebSocket");
      // Request initial players here on open
      socket.send(JSON.stringify({ type: "get_players" }));
  };

  socket.onerror = (err) => {
      console.error("WebSocket error:", err);
  };

  let players = {};
  let myId = null;

  socket.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    switch (msg.type) {
      case "players":
        msg.data.forEach(drawPlayer);
        break;
      case "new_player":
        drawPlayer(msg.data);
        break;
      case "move":
        const c = players[msg.data.id];
        if (c) {
          c.style.left = msg.data.x + "px";
          c.style.top = msg.data.y + "px";
        }
        break;
      case "name_changed":
        const char = players[msg.data.id];
        if (char) {
          char.querySelector(".player-name").textContent = msg.data.name;
        }
        break;
      case "created":
        myId = msg.data.id;
        drawPlayer(msg.data);
        break;
    }
  };


  function createPlayer() {
    const name = prompt("Choose a name:");
    if (name) {
      socket.send(JSON.stringify({ type: "create", data: { name } }));
    }
  }

  function drawPlayer(c) {
    if (players[c.id]) return;
    const div = document.createElement("div");
    div.className = "player";
    div.style.background = c.color;
    div.style.left = c.x + "px";
    div.style.top = c.y + "px";
    div.innerHTML = `
      <div class="player-name">${c.name}</div>
      <button onclick="changeName(${c.id})">Change Name</button>
      <button onclick="controlPlayer(${c.id}, '${c.name}')">Control</button>
    `;
    document.getElementById("game").appendChild(div);
    players[c.id] = div;
  }

  function changeName(id) {
    const name = prompt("New name?");
    if (name) {
      socket.send(JSON.stringify({ type: "change_name", data: { id, name } }));
    }
  }

  function controlPlayer(id, name) {
    myId = id;
    alert("You are now controlling: " + name);
  }

  // Handle arrow key movement
  window.addEventListener("keydown", (e) => {
    if (myId == null) return;
    const div = players[myId];
    if (!div) return;

    const x = parseInt(div.style.left);
    const y = parseInt(div.style.top);

    let newX = x, newY = y;
    if (e.key === "ArrowUp") newY -= 10;
    if (e.key === "ArrowDown") newY += 10;
    if (e.key === "ArrowLeft") newX -= 10;
    if (e.key === "ArrowRight") newX += 10;

    socket.send(JSON.stringify({ type: "move", data: { id: myId, x: newX, y: newY } }));
  });
</script>
</body>
</html>
